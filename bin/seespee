#!/usr/bin/env node

var AssetGraph = require('assetgraph'),
    urlTools = require('urltools'),
    commandLineOptions = require('optimist')
        .usage('$0 [--root <inputRootDirectory>] [--ignoremeta] [--existingpolicy ...] <htmlFile>...')
        .boolean('ignoremeta')
        .string('include')
        .demand(1)
        .argv;

var seenError = false;
new AssetGraph({root: commandLineOptions.root})
    .on('error', function () {
        seenError = true;
    })
    .logEvents({afterTransform: false})
    .loadAssets(commandLineOptions._.map(function (urlOrFsPath) {
        if (/^[a-z+-]+:\/\//i.test(urlOrFsPath)) {
            return urlOrFsPath;
        } else {
            return urlTools.fsFilePathToFileUrl(urlOrFsPath);
        }
    }))
    .queue(require('../lib/seespee')({
        include: commandLineOptions.include,
        ignoreMeta: commandLineOptions.ignoremeta
    }))
    .queue(function (assetGraph) {
        if (seenError || assetGraph.findAssets({type: 'ContentSecurityPolicy'}).length === 0) {
            process.exit(1);
        }
    })
    .run();
